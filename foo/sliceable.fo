#!(generic "foo")
###############################################################################
# sliceable.fo
#
# The Programmer - Leevi, @2012-10-04.
# C-Lab, Nirl Studio 2011-2013, All Rights Reserved.
#
###############################################################################
# 0, to define the operations of a 'sliceable' entity.
# 0.0, the offset of an element of 'sliceable' should be a zero-based integer.
# 0.1, the value of an element of 'sliceable' should support 'equal' or 'is'.
($impl sliceable
    # 1, basic properties.
    # 1.0, 'size' returns the amount of allocated slots, including all occupied and free ones.
    # 1.1, the value of '(sliceable:size )' should not be less than '(sliceable:count )'.
    (:Size ?int)
    #
    # 2, basic operations.
    # 2.0, ':get' overrides the operation of 'collection' to resolve 'item' as an offset.
    # 2.1, ':get' returns 'null' if the 'offset' is out of range.
    # 2.2, an negative offset should be equivalent to '(this:Size:add offset)'.
    (:get (= (! offset:int?0) ?* -)
    # 2.3, ':yield' returns a 'slicer' traversing elements in range of [from, to).
    # 2.4, ':yield' returns an empty list when the [from, to) is an empty set.
    # 2.5, both 'from' and 'to' could be negative values.
    # 2.6, 'from' will be evaluated to 0 if it refers to an invalid offset.
    # 2.7, 'to' will be evaluated to '(sliceable:count )' if it refers to an invalid offset.
    (:yield (= (! from:int?0 to:int) ?slicer -)
    # 2.8, 'cut' works like 'yield', but returns a list of elements in the range.
    (:cut (= (! from:int?0 to:int as_slice:bool?false) ?sliceable|slice -)
    #
    # 3, incremental update operations.
    # 3.0, these opertions will return an updated collection.
    # 3.1, overridden ':put' will replace existing elements from 'offset'. 
    (:put (= (! offset:int?0 item *) ?sliceable -)
    # 3.2, ':cas' sets the value at 'offset' to 'value' if it's not 'refer'.
    # 3.2.0, ':cas' returns 'this' if '(value:is refer)' is true.
    (:cas (= (! offset:int refer value) ?sliceable -)
    # 3.3, ':copy' will replace existing elements from 'offset' using items from 'source'.
    # 3.3.0, 'source' may be an 'iterator', 'slicer', 'iterable' or 'sliceable' entity.
    (:copy (= (! offset:int?0 src:iterator|iterable *) ?sliceable -)
    # 3.4, ':insert' will insert all 'item' from the position of 'offset'.
    (:insert (= (! offset:int?0 item *) ?sliceable -)
    # 3.5, ':prepend' will append all 'item' in arguments as the first one.
    (:prepend (= (! item *) ?sliceable -)
    # 3.6, ':merge' will insert all items in 'source' from 'offset'.
    (:merge (= (! offset:int?0 src:iterator|iterable *) ?sliceable -)
    # 3.7, ':append' will append all 'item' in arguments to the end.
    (:append (= (! item *) ?sliceable -)
    # 3.8, overridden ':join' will append all items in 'source' to the end.
    (:join (= (! src:iterator|iterable *) ?sliceable -)
    # 3.9, overridden ':remove' will remove all occurences of 'item'. 
    (:remove (= (! item *) ?sliceable -)
    # 3.10, ':delete' will remove all elements in range of [from, from+count). 
    (:delete (= (! from:int?0 count:int?1) ?sliceable -)
    # 3.11, ':swap' will swap the values indexed by 'p' and 'q'. 
    (:swap (= (! p:int q:int) ?sliceable -)
    # 3.12, ':reverse' will reverse all items in this collection. 
    (:reverse (= ?sliceable -)
    #
    # 4, searching for an item.
    # 4.0, 'sliceable' provides default implementations for 'find' and 'find_all'.
    # 4.1, ':find' returns the first offset for 'item' in the range of [from, to).
    # 4.2, ':find' returns integer '-1' if none is found.
    (:find (= (! item from:int?0 to:int) ?int -)
    # 4.3, ':find_all' returns a series of offset for 'item' in the range of [from, to).
    # 4.4, ':find_all' returns 'list:empty' if none is found.
    # 4.5, ':find_all' will return an 'iterator' if 'as_iterator' set to true.
    (:find_all (= (! item from:int?0 to:int as_iterator:bool) ?series|iterator -)
    #
    # 5, searching for any item in 'items'.
    # 5.0, 'sliceable' provides default implementations for 'scan' and 'scan_all'.
    # 5.1, 'items' may be an 'iterator', 'slicer', 'iterable' or 'sliceable' entity.
    # 5.2, ':scan' returns offset and item, where the 'offset' is minimal,
    # 5.3, 'item' is in the range of [from, to), and it may be anyone of 'items'.
    # 5.4, ':scan' returns integer '-1' and 'null' if none is found.
    (:scan (= (! iter:iterator|iterable from:int?0 to:int) ?int -)
    # 5.5, 'scan_all' returns an array of 'pair' containing offset and item,
    # 5.6, where 'item' is in the range of [from, to), and it may be anyone of 'items'.
    # 5.7, ':scan_all' returns 'list:empty' if none is found.
    # 5.8, ':scan_all' will return an 'iterator' if 'as_iterator' set to true.
    (:scan_all (= (! iter:iterator|iterable
                     from:int?0
                       to:int
              as_iterator:bool) ?array|iterator
    -)
    #
    # 6, matching for a permutation of 'sliceable'.
    # 6.0, 'sliceable' provides default implementation for 'match' and 'match_all'.
    # 6.1, 'perm' should be a 'sliceable' entity with correct type.
    # 6.2, ':match' returns the first offset for 'perm' in the range of [from, to).
    # 6.3, ':match' returns integer '-1' if none is matched.
    (:match (= (! perm:sliceable from:int?0 to:int) ?int -)
    # 6.4, ':match_all' returns a series of offset for 'perm' in the range of [from, to),
    # 6.5, ':match_all' returns 'list:empty' if none is matched.
    # 6.6, ':match_all' will return an 'iterator' if 'as_iterator' set to true.
    (:match_all (= (! perm:sliceable from:int?0 to:int as_iterator:bool) ?series|iterator -)
    #
    # 7, more common algorithms for 'sliceable'.
    # 7.0, 'sliceable' provides default implementation for them.
    # 7.1, ':sort' returns a new 'sliceable' containing sorted elements of the original one.
    # 7.2, the returned 'sliceable' will have same type of the original one.
    # 7.3, by default, the 'order' is 'ordering:Ascending'.
    # 7.4, by default, ':sort' will assume that items has implemented 'comparable'.
    # 7.5, by default, the 'algorithm' will be automatically selected by implementation.
    (:sort (= (! order:ordering comparer:function algorithm:string) ?sliceable -)
    # 7.6, ':topn' function returns a new 'sliceable' of containing top 'num' elements.
    # 7.7, by defualt, the 'order' is 'ordering:Descending'.
    (:topn (= (! num:int?1 order:ordering comparer:function algorithm:string) ?sliceable -)
    # 7.8, ':max' is used to find out the maximal value in the set.
    (:max (= (! comparer:function) ?* -)
    # 7.9, ':min' is used to find out the minimal value in the set.
    (:min (= (! comparer:function) ?* -)
) ;
###############################################################################
